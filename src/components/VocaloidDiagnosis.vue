<template>
  <div class="ContentsWrapper vocalog-bg">  
    <!-- スタート画面 -->
    <div v-if="currentStep === 'start'" class="start-screen">
      <div class="shinyu-bg">
        <swiper
          v-for="(config, index) in swiperConfigs"
          :key="index"
          :modules="[Autoplay]"
          :slides-per-view="1"
          :space-between="0"
          :loop="true"
          :autoplay="{
            delay: 0,
            disableOnInteraction: false,
            reverseDirection: config.reverse
          }"
          :speed="20000"
          class="title-swiper"
        >
          <swiper-slide v-for="n in 5" :key="n">
            <img src="/src/assets/img/title_bg.svg" alt="Background" class="title-bg-img"/>
          </swiper-slide>
        </swiper>
      </div>
      
      <div class="swipe-card-container">
        <!-- スワイプSVGを下に配置 -->
        <div class="swipe-animation">
          <Vue3Lottie
            :animationData="swipeAnimation"
            :height="220"
            :width="220"
            :loop="true"
            :autoPlay="true"
          />
        </div>
        
        <!-- カードを上に重ねて配置 -->
        <div class="card">
        </div>
      </div>
      
      <div class="percentage">{{ Math.round(loadingProgress) }}<span class="percent-symbol">%</span></div>
      <div class="percentage-underline-container">
        <div class="percentage-underline" :style="{ width: `${loadingProgress}%` }"></div>
      </div>
      
      <p class="start-description">
        ボカロ曲を「知ってる」か「知らない」か答えて、<br>あなたのタイプを診断しよう！
      </p>
      
      <button @click="() => { preloadedVideos.forEach(v => v.remove()); startDiagnosis(); }" class="start-btn">
        START
        <span class="arrow-icon">→</span>
      </button>
      
      <!-- 音声に関する注意書き -->
      <p class="audio-notice">
        ※このサイトは「音声」が流れます。<br>周りの環境や音量にご注意ください！
      </p>
      
      <!-- 音量ボタン（グローバル設定） -->
      <button @click="toggleMute" class="volume-btn" title="音声設定（全体に適用されます）">
        <img v-if="isMuted" src="/src/assets/img/volume_off.svg" alt="ミュート" class="volume-icon">
        <img v-else src="/src/assets/img/volume_on.svg" alt="音量オン" class="volume-icon">
        <span class="volume-tooltip">音量設定</span>
      </button>
    </div>
    
    <!-- 診断画面 -->
    <div v-else-if="currentStep === 'diagnosis'" class="diagnosis-screen">
      <div class="diagnosis-screen-header">
        <div class="progress-bar-container">
          <div class="progress-bar">
            <div class="progress-fill" :style="{ width: `${(answeredCount / totalQuestions) * 100}%` }"></div>
          </div>
          <div class="progress-text">{{ answeredCount }}/{{ totalQuestions }}曲</div>
          <!-- 音量ボタン（グローバル設定） -->
          <button @click="toggleMute" class="volume-btn" title="音声設定（全体に適用されます）">
            <img v-if="isMuted" src="/src/assets/img/volume_off.svg" alt="ミュート" class="volume-icon">
            <img v-else src="/src/assets/img/volume_on.svg" alt="音量オン" class="volume-icon">
            <span class="volume-tooltip">音量設定</span>
          </button>
        </div>
        
        <div class="swipe-indicators">
          <div class="swipe-left">
            <span class="indicator-icon">🙂‍↔️</span>
            <span class="indicator-text">知らない</span>
          </div>
          <div class="swipe-right">
            <span class="indicator-text">知ってる</span>
            <span class="indicator-icon">🙂‍↕️</span>
          </div>
        </div>
      </div>
      
      <div class="tinder-container">
        <div 
          class="tinder-card"
          v-for="(song, index) in visibleCards" 
          :key="song.id"
          :class="{ 'top-card': index === 0 }"
          :style="getCardStyle(index)"
            @mousedown="startDrag"
            @mousemove="onDrag"
            @mouseup="endDrag"
            @mouseleave="endDrag"
            @touchstart="startDrag"
            @touchmove="onDrag"
            @touchend="endDrag"
        >
        <video 
          class="thumbnail-video" 
          :ref="el => setVideoRef(el, index)"
          loop
          playsinline
          webkit-playsinline
          preload="auto"
          :poster="getVideoPath(song)"
          :style="{ visibility: index <= 2 ? 'visible' : 'hidden' }"
          :volume="0.1"
        >
        <source :src="`${getVideoPath(song)}#t=${song.startTime ?? 0.1}`" type="video/mp4">
        </video>
        <div class="song-info">
          <h2 class="song-title">{{ song.title }}</h2>
          <p class="song-producer">{{ song.producer }}</p>
          <p class="song-year">{{ song.year }}年</p>
        </div>
        </div>
      </div>
      
      <!-- 知ってる！エフェクト -->
      <div v-if="showKnowEffect" class="know-effect">
        <div class="effect-content">
          <div class="effect-stamp">知ってる！</div>
          <div class="effect-comment">{{ currentKnowComment }}</div>
        </div>
      </div>
      
      <!-- 知らない！エフェクト -->
      <div v-if="showDontKnowEffect" class="dont-know-effect">
        <div class="effect-content">
          <div class="effect-stamp">知らない！</div>
        </div>
      </div>
      
      
      <div class="padded-content">
        <div class="manual-buttons">
          <button type="button" @click="rejectCard" class="dont-know-btn">
            <span class="btn-icon">🙂‍↔️</span> 知らない！
          </button>
          <button type="button" @click="acceptCard" class="know-btn">
            知ってる！<span class="btn-icon">🙂‍↕️</span>
          </button>
        </div>
        <!-- デバッグ用ボタン -->
        <div class="debug-button-container">
          <button type="button" @click="debugAllKnown" class="debug-btn">
            デバッグ：全て知ってる
          </button>
        </div>
      </div>
    </div>
    
    <!-- 結果画面 -->
    <ResultScreen 
      v-else-if="currentStep === 'result'"
      :knownSongs="knownSongs"
      :totalQuestions="totalQuestions"
      :isMuted="isMuted"
      @toggleMute="toggleMute"
      @resetDiagnosis="resetDiagnosis"
    />
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref } from 'vue';
import 'animate.css';
import { Vue3Lottie } from 'vue3-lottie';
import swipeAnimation from '../assets/lottie/swipe.json';
// Swiperのインポート
// @ts-ignore
import { Swiper, SwiperSlide } from 'swiper/vue';
// @ts-ignore
import { Autoplay } from 'swiper/modules';
// @ts-ignore
import 'swiper/css';

// 結果画面コンポーネントをインポート
import ResultScreen from './ResultScreen.vue';

// 型定義をインポート
import type { VocaloidSong } from '../type';
import { ANIMATION, PRELOAD, DEFAULT_VIDEO_PATH } from '../constants';

// composablesをインポート
import { useDiagnosisState } from '../composables/useDiagnosisState';
import { useDiagnosisLogic } from '../composables/useDiagnosisLogic';
import { useTinderCards } from '../composables/useTinderCards';
import { useEffects } from '../composables/useEffects';
import { useAudioControl } from '../composables/useAudioControl';

// Swiperの設定を配列で管理
const swiperConfigs = [
  { reverse: false },
  { reverse: true },
  { reverse: false },
  { reverse: true }
];

// 状態を取得
const { 
  currentStep, 
  answeredSongs, 
  knownSongs, 
  currentSongIndex,
  diagnosisSongs,
  remainingSongs,
  answeredCount,
  totalQuestions,
  currentSong
} = useDiagnosisState();

// 診断ロジック
const { 
  startDiagnosis, 
  resetDiagnosis 
} = useDiagnosisLogic(
  currentStep, 
  answeredSongs, 
  knownSongs, 
  currentSongIndex, 
  diagnosisSongs,
  totalQuestions
);

// エフェクト関連
const {
  showKnowEffect,
  showDontKnowEffect,
  currentKnowComment,
  initSounds,
  displayKnowEffect,
  displayDontKnowEffect
} = useEffects();

// 音声制御関連
const { toggleMute, isMuted } = useAudioControl('VocaloidDiagnosis');

// Tinderカード関連
const {
  visibleCards,
  getCardStyle,
  startDrag,
  onDrag,
  endDrag,
  rejectCard,
  acceptCard,
  setVideoRef,
  controlVideos
} = useTinderCards(
  currentStep, 
  answeredSongs, 
  knownSongs, 
  diagnosisSongs,
  remainingSongs,
  currentSongIndex,
  currentSong,
  totalQuestions,
  { displayKnowEffect, displayDontKnowEffect }
);

// 動画パスを取得する関数
const getVideoPath = (song: VocaloidSong) => {
  if (song.videoPath) {
    return `/src/assets/movie/${song.videoPath}`;
  }
  
  // デフォルト動画パス
  return DEFAULT_VIDEO_PATH;
};

// 読み込み進捗を管理する変数
const loadingProgress = ref(0);

// 動画のプリロード用の配列
const preloadedVideos = ref<HTMLVideoElement[]>([]);

// 最初の3曲の動画をプリロードする関数
const preloadInitialVideos = () => {
  loadingProgress.value = 0;
  
  // 既存のプリロード済み動画をクリア
  preloadedVideos.value.forEach(video => {
    video.remove();
  });
  preloadedVideos.value = [];

  // 最初の3曲を取得
  const initialSongs = diagnosisSongs.value.slice(0, PRELOAD.INITIAL_VIDEOS);
  
  // 読み込み進捗の計算用
  const totalVideos = initialSongs.filter(song => song.videoPath).length;
  let loadedVideos = 0;
  
  // 各曲の動画をプリロード
  initialSongs.forEach((song) => {
    if (song.videoPath) {
      const video = document.createElement('video');
      video.preload = 'auto';
      video.muted = true;
      video.style.display = 'none';
      video.src = `/src/assets/movie/${song.videoPath}#t=${song.startTime ?? 0.1}`;
      
      video.addEventListener('loadstart', () => {
        loadingProgress.value += PRELOAD.PROGRESS_INCREMENT;
      });
      
      video.addEventListener('canplay', () => {
        loadedVideos++;
        loadingProgress.value = Math.min(PRELOAD.MAX_PROGRESS, (loadedVideos / totalVideos) * PRELOAD.MAX_PROGRESS);
        
        if (loadedVideos === totalVideos) {
          setTimeout(() => {
            loadingProgress.value = 100;
          }, PRELOAD.COMPLETE_DELAY);
        }
      });
      
      video.addEventListener('error', () => {
        loadedVideos++;
        loadingProgress.value = Math.min(PRELOAD.MAX_PROGRESS, (loadedVideos / totalVideos) * PRELOAD.MAX_PROGRESS);
        
        if (loadedVideos === totalVideos) {
          setTimeout(() => {
            loadingProgress.value = 100;
          }, PRELOAD.COMPLETE_DELAY);
        }
      });

      video.load();
      preloadedVideos.value.push(video);
      document.body.appendChild(video);
    }
  });
  
  // フォールバック
  setTimeout(() => {
    loadingProgress.value = 100;
  }, PRELOAD.TIMEOUT);
};

// デバッグ用：全ての曲を「知ってる」としてマークし、結果画面に遷移する関数
const debugAllKnown = () => {
  // 全ての曲のIDを取得
  const allSongIds = diagnosisSongs.value.map(song => song.id);
  
  // 全ての曲を回答済みとしてマーク
  answeredSongs.value = [...allSongIds];
  
  // 全ての曲を「知ってる」としてマーク
  knownSongs.value = [...allSongIds];
  
  // 結果画面に遷移
  currentStep.value = 'result';
};

// ページロード時の処理
onMounted(() => {
  initSounds();
  currentStep.value = 'start';
  
  if (currentStep.value === 'start') {
    preloadInitialVideos();
  }
  else if (currentStep.value === 'diagnosis') {
    controlVideos();
  }
});
</script>

<style scoped>
/* スタート画面の背景 */
.vocalog-bg {
  background-color: #FFF;
  position: relative;
}

/* 背景に薄く繰り返し表示されるSHINYUタイトル */
.shinyu-bg {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
  gap: 0;
}

/* Swiperスライダーのスタイル */
.title-swiper {
  width: 100%;
  flex: 1 1 0%;
  margin: 0;
  padding: 0;
}

/* スライド内の画像のスタイル */
.title-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  margin: 0;
  padding: 0;
}

/* Swiperのナビゲーションとページネーションを非表示 */
:deep(.swiper-button-next),
:deep(.swiper-button-prev),
:deep(.swiper-pagination) {
  display: none !important;
}

/* Swiperのスライドスタイル */
:deep(.swiper-slide) {
  opacity: 1;
  z-index: 1;
  margin: 0;
  padding: 0;
}

/* Swiperのコンテナスタイル */
:deep(.swiper) {
  overflow: visible;
  margin: 0;
  padding: 0;
}

/* Swiperのラッパースタイル */
:deep(.swiper-wrapper) {
  transition-timing-function: linear !important;
  margin: 0;
  padding: 0;
}

/* 100%表示 */
.percentage {
  font-size: 4rem;
  font-weight: bold;
  color: #FFCC00;
  text-align: center;
  margin-bottom: 5px;
  position: relative;
  display: inline-block;
  width: 100%;
  z-index: 1;
}

.percent-symbol {
  font-size: 2rem;
  position: relative;
  top: 1.2rem;
  vertical-align: super;
}

.percentage-underline-container {
  width: 150px;
  height: 3px;
  background-color: rgba(255, 204, 0, 0.3);
  margin: 0 auto 20px;
  z-index: 1;
  position: relative;
  overflow: hidden;
}

.percentage-underline {
  height: 100%;
  background-color: #FFCC00;
  position: absolute;
  left: 0;
  top: 0;
  transition: width 0.3s ease-out;
}

/* 説明文 */
.start-description {
  text-align: center;
  margin-bottom: 30px;
  color: #333;
  font-size: 0.8rem;
  line-height: 1.6;
  position: relative;
  z-index: 1;
}

/* スタートボタン */
.start-btn {
  background-color: #222;
  color: white;
  border: none;
  padding: 15px 60px;
  font-size: 1.2rem;
  font-weight: bold;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
}

.arrow-icon {
  margin-left: 10px;
  font-size: 1.2rem;
}

.start-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
}

/* 音声に関する注意書き */
.audio-notice {
  text-align: center;
  color: #686868;
  line-height: 1.6;
  font-size: 0.8rem;
  margin-top: 10px;
  margin-bottom: 20px;
  position: relative;
  z-index: 1;
}

/* 音量ボタンの位置調整 */
.volume-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.3);
}

.thumbnail-video {
  width: 100%;
  border-radius: 30px 30px 0 0;
  aspect-ratio: 16 / 9;
  background-color: #000;
}

/* Tinderスタイルのカードスワイプ用スタイル */
.tinder-container {
  position: relative;
  width: 100%;
  height: 400px;
  max-width: 360px;
  margin: 0 auto;
}

.tinder-card {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  display: flex;
  flex-direction: column;
  touch-action: none;
  will-change: transform;
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border-radius: 30px;
  box-shadow: rgb(237 237 237 / 60%) 0px 5px 20px;
  background-color: #fff;
  transform-origin: center center;
}

.tinder-card:nth-child(1) {
  z-index: 2;
}

.tinder-card:nth-child(2) {
  z-index: 1;
  transform: scale(0.95) translateY(10px);
  opacity: 0.8;
  filter: blur(1px);
}

.song-info {
  padding: 20px;
  flex-grow: 1;
}

.song-title {
  font-size: 1.2rem;
}

.song-producer {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 5px;
}

.song-year {
  font-size: 0.7rem;
  color: #999;
}

/* 音量ボタンのスタイル */
.volume-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 5px;
  margin-left: 10px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(255, 255, 255, 0.2);
  transition: background-color 0.3s;
  position: absolute;
}

.volume-btn:hover {
  background-color: rgba(255, 255, 255, 0.3);
}

/* 音量ボタンのツールチップ */
.volume-tooltip {
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  background-color: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

.volume-btn:hover .volume-tooltip {
  opacity: 1;
}

/* 音量アイコンのスタイル */
.volume-icon {
  width: 24px;
  height: 24px;
}

/* 診断画面の音量ボタン */
.progress-bar-container .volume-btn {
  position: absolute;
  right: 10px;
  top: 10px;
}

/* デバッグボタンのスタイル */
.debug-button-container {
  display: flex;
  justify-content: center;
  margin-top: 15px;
}

.debug-btn {
  background-color: #ff6b6b;
  color: white;
  border: none;
  padding: 10px 20px;
  font-size: 0.9rem;
  font-weight: bold;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.debug-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

/* 800px以下のときに「知ってる」「知らない」ボタンを非表示にする */
@media (max-width: 800px) {
  .manual-buttons {
    display: none;
  }
}

/* スワイプカードコンテナのスタイル */
.swipe-card-container {
  position: relative;
  width: 100%;
  max-width: 280px;
  margin-bottom: 45px;
  z-index: 1;
}

/* スワイプアニメーション部分 */
.swipe-animation {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
  width: 220px;
  height: 220px;
}

/* カードのスタイル */
.card {
  background-color: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  padding: 20px;
  z-index: 2;
  height: 240px;
}
</style>
